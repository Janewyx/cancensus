---
title: "Bar Graph Demo"
author: "Jens von Bergmann"
date: "2017-08-15"
output: html_notebook
#output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

We demonstrate how to import data from the [CensusMapper](https://CensusMapper.ca) API. The code for this notbook can be found on [GitHub](https://github.com/mountainMath/cancensus).

This example demonstrates how to dynamically discover regions and vectors and produce an overview graph based on the data by using the `cancensus.list_regions`, `cancensus.list_vectors` and `cancensus.search_vectors` methods.

```{r API Key, echo=TRUE, warning=FALSE}
library(cancensus)
# set your API key
# options(cancensus.api_key)='<your API key>'

# use 2016 data
dataset='CA16'
```

### Dynamically Select Regions
We select the top 6 CMAs by population.
```{r, echo=TRUE, message=FALSE, warning=FALSE}
# grab 6 largest CMAs
cma_list <- cancensus.list_regions(dataset) %>% 
  filter(level=='CMA') %>% 
  top_n(6, pop) %>%
  pull(region)
regions=list(CMA=cma_list)
```

### Dynamically Select Vectors
We query the vectors for the *structural type of dwelling* variables grab all non-summary variables.
```{r, echo=TRUE, message=FALSE, warning=FALSE}
# get the base vector
dwellings <- cancensus.search_vectors("structural type of dwelling",dataset)
# get all dependent vectors
n=0
while (n<length(dwellings)) {
  n=nrow(dwellings)
  dwellings <- bind_rows(list(dwellings,cancensus.list_vectors(dataset) %>% filter(parent_vector %in%  (dwellings %>% pull(vector))))) %>% distinct(vector, .keep_all = TRUE)
}
# filter out so we are only left with leaves
dwellings <- dwellings %>% filter(! vector %in%  (dwellings %>% pull(parent_vector)))

#set vectors
vectors=dwellings %>% pull(vector)
```


### Get the census data
Next we grab the census data, set colors and order the categories we want to graph based on the data.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# get data for these CMAs
census_data <- cancensus.load(dataset='CA16', regions=regions, vectors=vectors, level='Regions',geo_format=NA,labels='short')


# labels and colors
categories=cancensus.labels(census_data)
# shorten label names
categories$Detail[grepl(" in a building that has ",categories$Detail)] <- gsub(" in a building that has ",", ",categories$Detail[grepl(" in a building that has ",categories$Detail)])
#set colors
categories$Color=c('yellow','darkblue','lightgreen','red','orange','lightblue','purple','maroon')

# convert to percentages
census_data %>% select(categories$Vector) %>% rowSums(na.rm=TRUE) -> census_data$total
for (v in categories$Vector) {census_data[[v]]=census_data[[v]]/census_data$total * 100}

#sort categories by percentages in data across CMAs
sorted_vectors=names(sort(colSums(census_data[,categories$Vector],na.rm=TRUE)))
categories <- categories[order(match(categories$Vector,sorted_vectors)),]
```


### Graph
All that's left to do is graph the data.
```{r, fig.width=5}
# set variable name without space to avoid hiccups.
census_data$name=census_data[["Region Name"]]

library(ggplot2)
plot_data <- reshape2::melt(census_data %>% select(c(c("name"),categories$Vector)),id.vars = "name")
ggplot(plot_data,aes(name,y=value)) +
  scale_fill_manual("Dwelling Type",labels = categories$Detail, values=categories$Color) + 
  geom_bar(aes(fill=variable),stat="identity") + 
  labs(x="6 largest CMAs", y="Share of occupied dwelling units (%)", title="Occupied Private Dwellings by Structural Type of Dwelling",caption="Canada Census 2016 via cancensus & censusmapper.ca")
```

